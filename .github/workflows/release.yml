name: Build & Release All

on:
  push:
    tags:
      - "v*"

jobs:
  # --- LINUX (DEB & RPM) ---
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install Dependencies
        run: sudo apt-get install -y libgtk-4-dev libadwaita-1-dev rpm
      - name: Install Tools
        run: |
          cargo install cargo-generate-rpm
          cargo install cargo-deb
      - name: Build
        run: cargo build --release
      - name: Package
        run: |
          cargo generate-rpm
          cargo deb
      - name: Upload Linux Assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            target/generate-rpm/*.rpm
            target/debian/*.deb

  # --- WINDOWS (MSI) ---
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: msys2/setup-msys2@v2
        with:
          install: mingw-w64-x86_64-gtk4 mingw-w64-x86_64-libadwaita
      - name: Install WiX
        run: cargo install cargo-wix
      - name: Init WiX (First run only logic handled by cargo-wix usually, but for CI we just run it)
        run: cargo wix --no-build --nocapture || echo "WiX init skipped"
      - name: Build & Package MSI
        run: cargo wix
      - name: Upload MSI
        uses: softprops/action-gh-release@v1
        with:
          files: target/wix/*.msi

  # --- MACOS (DMG) ---
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      # Use cargo-bundle for DMG
      - name: Install Tools
        run: cargo install cargo-bundle
      - name: Build & Package
        run: |
          # GTK4 on Mac is tricky, usually requires brew
          brew install gtk4 libadwaita adwaita-icon-theme
          cargo bundle --release
      - name: Zip Bundle (DMG creation is complex, ZIP is standard for Mac releases)
        run: |
          cd target/release/bundle/osx
          zip -r mkbib-macos.zip MkBib.app
      - name: Upload Mac Asset
        uses: softprops/action-gh-release@v1
        with:
          files: target/release/bundle/osx/mkbib-macos.zip
